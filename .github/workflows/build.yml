name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            output: sublink_amd64
          - goos: linux
            goarch: arm64
            output: sublink_arm64
          - goos: windows
            goarch: amd64
            output: sublink_windows_amd64.exe
          - goos: darwin
            goarch: amd64
            output: sublink_darwin_amd64
          - goos: darwin
            goarch: arm64
            output: sublink_darwin_arm64

    steps:
    - uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.22'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build frontend
      run: |
        cd webs
        npm install
        npm run build

    - name: Build backend
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        go mod tidy
        go build -ldflags="-s -w" -o ${{ matrix.output }} main.go

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.output }}
        path: ${{ matrix.output }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: ./artifacts

    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Release ${{ github.ref_name }}
        body: |
          ## SublinkX ${{ github.ref_name }}

          ### ğŸ‰ æ–°åŠŸèƒ½
          - æ™ºèƒ½ä»£ç†ç»„é€‰æ‹©ï¼šåªå‘åŒ…å«ç‰¹å®šå…³é”®è¯çš„ä»£ç†ç»„æ·»åŠ èŠ‚ç‚¹
          - ä¼˜åŒ–èŠ‚ç‚¹åˆå¹¶é€»è¾‘ï¼Œå‡å°‘é…ç½®å†—ä½™

          ### ğŸ”§ æ”¹è¿›
          - ç®€åŒ–å…³é”®è¯åŒ¹é…ï¼š`èŠ‚ç‚¹é€‰æ‹©`ã€`è‡ªåŠ¨é€‰æ‹©`ã€`æ‰‹åŠ¨åˆ‡æ¢`
          - ç§»é™¤ä»£ç†ç»„æ•°é‡é™åˆ¶ï¼Œæ”¯æŒä»»æ„æ•°é‡çš„ç¬¦åˆæ¡ä»¶çš„ä»£ç†ç»„
          - ä¼˜åŒ–ä»£ç ç»“æ„ï¼Œæé«˜æ€§èƒ½

          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - `sublink_amd64`: Linux x86_64
          - `sublink_arm64`: Linux ARM64
          - `sublink_windows_amd64.exe`: Windows x86_64
          - `sublink_darwin_amd64`: macOS Intel
          - `sublink_darwin_arm64`: macOS Apple Silicon

          ### ğŸš€ å¿«é€Ÿå®‰è£…
          ```bash
          curl -s -H "Cache-Control: no-cache" -H "Pragma: no-cache" https://raw.githubusercontent.com/moshouhot/sublinkX/main/install.sh | sudo bash
          ```
        draft: false
        prerelease: false
        files: |
          ./artifacts/*/sublink_*
